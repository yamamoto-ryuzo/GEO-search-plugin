name: Update Translations

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-translations:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt tools (lupdate/lrelease)
        run: |
          sudo apt-get update
          sudo apt-get install -y qttools5-dev-tools qttools5-dev

      - name: Show lupdate/lrelease versions
        run: |
          lupdate --version || true
          lrelease --version || true

      - name: Run lupdate
        working-directory: geo_search
        run: |
          lupdate . -no-obsolete -ts i18n/*.ts

      - name: Run lrelease
        working-directory: geo_search
        run: |
          # generate .qm files from ts
          lrelease i18n/*.ts || true

      - name: Check for translation diffs
        working-directory: geo_search
        run: |
          git add -A
          if ! git diff --cached --exit-code; then
            echo "Translations or .ts files changed; please update and commit."
            git --no-pager diff --staged || true
            exit 1
          else
            echo "No translation diffs.";
          fi

      - name: Upload compiled .qm artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translation-qm
          path: geo_search/i18n/*.qm
