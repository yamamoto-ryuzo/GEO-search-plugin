
# GEO Search System（地図検索システム）

[English / 英語版 (README.md)](./README.md) 

<a id="overview"></a>
## 概要

このリポジトリは「GEO Search System」を実装するもので、QGIS 上で動作するモジュール群を含みます。主な目的は地番検索、所有者名検索、汎用的な属性検索を提供することです。検索結果はレイヤごとにタブで表示され、表示フィールドやページングを柔軟に設定できます。

特に「テーマ（map theme）」は検索機能の重要な要素です。本プラグインではタブごとに `selectTheme` を指定でき、検索実行時にそのテーマを自動的に適用して、レイヤのシンボル・ラベル・可視化状態・レンダリング順などを再現します。テーマの適用はプロジェクト内に保存されたスタイル名を手がかりにベストエフォートで復元し、テーマが見つからない場合でも安全に検索表示が行えるようフォールバックします。

また「追加表示モード」を使うと、既存のプロジェクト表示を上書きせずに検索結果の可視レイヤを追加表示できます。追加表示モードでは、元の表示とテーマ適用後の可視レイヤの和集合が最終的に表示されるため、検索による見え方を崩さずに結果を重ねて見せることができます。テーマの保存・復元により、検索結果の見え方を一貫して運用できる点が本プラグインの特徴です。

Qt5 および Qt6（QGIS 3.x）環境での互換性にも配慮しています。


<a id="features"></a>
## 主要機能

<a id="search-feature"></a>
### 検索機能

- 地番検索（地籍筆番）・所有者名検索・汎用属性検索をサポート。
- 結果はレイヤごとにタブ表示し、表示フィールドのカスタマイズとページングをサポート。
- 結果行をクリックすると地図上で該当フィーチャにズーム／選択。

<a id="theme-mode"></a>
### テーマ追加表示モードと管理

- 検索結果を既存プロジェクトの表示に"追加"するモードを提供（既存レイヤや凡例を保持したまま上書きしない表示）。
- 検索時に適用するテーマ（`selectTheme`）をタブごとに指定可能。起動時の表示状態は自動的に "検索前" として保存できます。
- テーマ適用はベストエフォートで保存済みのスタイル名を元に再現します。追加表示モードでは、元の表示とテーマ適用後の可視レイヤの和集合が最終表示になります。


<a id="quickstart"></a>
## クイックスタート

1. プラグインのインストール
	- `geo_search` フォルダを QGIS のユーザー用プラグインディレクトリにコピーするか、作成済みの ZIP を QGIS のメニューからインストールします（`Plugins → Manage and Install Plugins → Install from ZIP`）。
2. 起動
	- QGIS でプラグインを有効化し、ツールバーの起動ボタンをクリックして検索ダイアログを開きます。
3. 検索
	- タブを選択または新規設定し、地番・所有者名・属性などを入力して「検索」を押します。
4. 結果確認
	- 結果はレイヤごとのタブに表示されます。列幅が狭い場合はテーブルヘッダーで自動調整してください。

トラブルシュートの基本は、プラグインの再読み込みや QGIS 再起動、README にある診断スニペットの実行です。


<a id="core-details"></a>
## コア機能の詳細

コアな検索ロジックやタブ設定の詳細は `SEARCH.md` に移行しています。実装ファイルへの参照や設定例はそちらを参照してください。


<a id="tab-settings"></a>
## タブごとの設定（SearchTab）

各タブは `SearchTab` 設定で定義します。主なキーは次の通りです（詳細は `SEARCH.md` を参照）：

- `Title`: タブ名（`地番検索` や `所有者検索` の場合は特殊処理）
- `group`: タブをまとめるグループ名
- `Layer`: 対象レイヤの指定（`Name` / `File` / `Database`）
- `SearchField` / `SearchFields`: 検索対象フィールド
- `ViewFields`: 結果表示フィールド（空配列で全フィールド表示）
- `selectTheme`: 検索時に適用するマップテーマ名（省略可）
- `angle` / `scale`: タブ単位で適用する回転角度・縮尺（未指定は適用しない）

サンプル設定や詳しいフォーマットは `setting.json.sample` と `SEARCH.md` を参照してください。


<a id="config-sources"></a>
## 設定ソースと利用者ロール

本プラグインは設定の柔軟性を高めるため、3 種類の設定ソースをサポートします。目的別に誰がどのソースを編集するかを整理すると次の通りです。

1. システム管理者 — `setting.json`（プラグイン同梱、サイト／組織のデフォルト）
	- 目的: プラグイン全体に適用する組織的なデフォルト設定を提供します。
	- 編集者: プラグイン管理者やシステム管理者（インストール時やバージョンアップ時に更新）
	- 注意: プラグインインストールフォルダへの書き込み権限が必要。全ユーザーに影響します。

2. 編集者 — `GEO-search-plugin`（プロジェクト変数、プロジェクト単位の設定）
	- 目的: 該当 QGIS プロジェクトに紐づく設定を保存します。プロジェクトと共に設定を配布したい場合に使用します。
	- 編集者: プロジェクト作成者や編集担当者
	- 備考: プロジェクト変数は inline の JSON を直接持つことも、プロジェクト内の外部ファイルパスを指すこともできます。

3. 閲覧者 — `geo_search_json`（外部 JSON ファイル、ユーザー個別または一時的）
	- 目的: プロジェクトやプラグインのファイルを変更せずに個人用・一時的な設定を追加する用途に便利です。
	- 編集者: 個々のユーザー（ローカルの設定やちょっとした追加を反映したい場合）
	- 備考: 環境変数 `geo_search_json` またはプロジェクト変数でファイルパスを指定して利用できます。

**動作のまとめ（運用上の注意）**

- 読み込み順（結合順）は以下の通りです：`setting.json`（プラグイン）→ `GEO-search-plugin`（プロジェクト）→ `geo_search_json`（外部）。後に読み込まれた項目は末尾に追加されます。
- 読み込んだ各タブには `_source`（読み込み元）と `_source_index`（そのソース内の 0 ベースの順序）が注釈として付与され、編集・削除処理の対象特定に使われます。
- 編集・削除処理は可能な限り `_source_index` による直接指定を試み、失敗した場合は `Title` によるフォールバック検索を行います（並行編集や手動編集への耐性を高めるため）。
- プラグインはファイル更新時にバックアップを作成し、原子的に書き換えを行います。更新後は UI を再構築して `_source_index` を再計算するため、表示上のインデックス不整合は解消されます。

推奨利用法の早見表：
- サイト全体のデフォルトを管理する場合 → `setting.json`（システム管理者）
- プロジェクト単位で共有したい場合 → `GEO-search-plugin`（プロジェクト変数、編集者）
- 個人用や一時的な追加・実験用途 → `geo_search_json`（閲覧者）


<a id="qt6"></a>
## Qt6 / QGIS (3.44+) 対応について

- 本プラグインは Qt5 と Qt6 両対応を目標としています。`metadata.txt` に `supportsQt6 = True` を設定しています。
- PyQt のインポートを `qgis.PyQt` 経由に統一し、Qt5/6 の差分を吸収するための互換層を `geo_search/qt_compat.py` に置いています。
- Qt6 固有の描画タイミング差に対する UI の安定化（テーブルヘッダーのリサイズや最終列ストレッチ、最小幅設定など）を導入しています。


<a id="troubleshoot"></a>
## トラブルシュート：画面が空白 / 属性列が狭い場合

- まずプラグインを無効化→上書き→有効化、または QGIS を再起動してみてください。
- 結果ダイアログの列を右クリックして「列を自動調整」を試してください。
- それでも改善しない場合は、Python コンソールでプラグインのダイアログ状態を出力する診断スニペットを実行し、出力をサポートに提供してください（`SEARCH.md` にも診断手順を記載しています）。


<a id="search-logic"></a>
## 検索ロジック（実装概要）

詳細な実装や検索アルゴリズムの説明は `SEARCH.md` を参照してください。主要な実装ファイルは `geo_search/widget/searchwidget.py`、`geo_search/searchfeature.py` などです。


<a id="pan-mode"></a>
## パンモード（地図移動挙動）

検索結果を選択した後の地図移動は複数モードで制御できます：

- ズーム to 選択（デフォルト）
- 中心パン（ズーム維持）
- 固定スケール表示
- アニメーションパン
- 選択のみ（ビューを変更しない）

設定は検索ダイアログの `panModeComboBox` で行います。


<a id="changelog"></a>
## 更新履歴

- **V3.3.0** — 設定ソースの多様化：`setting.json`（プラグイン内）・`GEO-search-plugin`（プロジェクト変数）・`geo_search_json`（外部ファイル）の 3 方式を統合して読み込み。各タブに `_source` / `_source_index` を付与し、編集・削除フローと UI 表示の改善を行いました。
- **V3.0.0** — テーマ選択・追加表示モード等の大きな改善
- **V2.0.0** — 初期の UI と互換性改善
- **V1.0.0** — 基本検索機能の実装


---

詳しい設定例や運用ルール、サンプル JSON は `SEARCH.md` と `setting.json.sample` を参照してください。

