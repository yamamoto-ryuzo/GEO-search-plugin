```markdown
# マップテーマ（Map Themes）機能の概要 — テーマ管理サブシステム

このドキュメントは `GEO Search System` におけるテーマ／表示管理サブシステム（Map Themes）の設計と実装についてまとめたものです。検索サブシステムと連携して検索時の表示適用や「追加表示モード」を提供する役割を担います。

**目的（サブシステムとして）**
- QGIS のマップテーマ（Map Theme）を一覧取得・即時適用できるAPIとUIを提供し、検索ワークフローと統合する。
- 検索実行時にあらかじめ設定されたテーマを自動で適用する（必要に応じて現在表示状態を `検索前` として保存し、復元可能にする）。

---

**実装のポイント（高レベル）**

- ツールバーに `QComboBox`（テーマ選択用）を追加し、プロジェクト内のマップテーマ一覧を表示する。
- プロジェクトのテーマコレクションが変更されたり（追加/削除）、プロジェクトが保存/読み込みされたときにコンボボックスを自動更新する。
- コンボボックスでテーマを選択すると、その場で該当テーマを適用する。
- 検索実行時には各タブ設定の `selectTheme`（設定ファイル / プロジェクト変数）を参照して、そのテーマを適用する。指定がなければテーマ切替は行わない。
- プラグイン起動時に現在の表示状態を "検索前" という名前で自動保存し、`selectTheme` に "検索前" を指定すると起動時の表示状態に復帰できる。

---

**主な実装ファイルと関数**

- `geo_search/plugin.py`
  - `initGui()`
    - ツールバーに `theme_combobox` を作成し `update_theme_combobox()` を呼ぶ。
    - プロジェクトの読み込み・保存イベントやテーマコレクションの変更を監視して `update_theme_combobox()` を再実行する接続を行う。
  - `update_theme_combobox()`
    - `QgsProject.instance().mapThemeCollection().mapThemes()` からテーマ名リストを取得し、コンボをクリアして "テーマ選択"（プレースホルダ）とテーマ群を再追加する。
    - 現在は、ツールバーのもう一つの `group_combobox` によるグループ絞り込みをサポートしており、グループが未選択（プレースホルダ `すべて`）の場合は全てのテーマを表示します。グループ選択がある場合はそのグループのテーマのみを表示します。
    - テーマ適用処理が走っている最中に QGIS 側のシグナルで誤ってリストが書き換わるのを防ぐため、適用中は自動更新を抑止する仕組みが入っています（`_suppress_theme_update` フラグ）。
  - `apply_selected_theme(index)`
    - コンボの選択イベントで呼ばれ、選択されたテーマ名を `theme_collection.applyTheme(theme_name, root, model)` で適用する。
    - 以前はプラグイン内で「選択を内部に記録して更新時に復元する」仕組みがありましたが、ユーザ操作の明示性を優先するためその自動復元ロジックは削除されています。
    - また、`applyTheme` によって内部的にテーマコレクションが変化した場合に発生し得る `mapThemesChanged` 等のシグナルで UI が書き換わらないよう、適用中は `update_theme_combobox()` を抑止するフラグを立てて一時的に更新を防ぎます。
  - `run()`
    - 検索ダイアログ表示の直前に現在の表示状態を `検索前` という名前で `mapThemeCollection` に保存する処理がある（検索実行前スナップショット）。

- `geo_search/searchfeature.py`
  - `SearchFeature.show_features()`（および、派生クラスの呼び出し箇所）
    - `self.setting.get('selectTheme')` を読み、存在かつプロジェクトに存在するテーマ名であればそのテーマを適用する。
    - `selectTheme` が未指定なら何もしない。設定があるが見つからない場合はログに警告を書く。
    - `selectTheme` が未指定でも `検索前` が存在する場合は `検索前` を適用する（下位互換的な扱い）。

- `README.md`
  - ユーザ向けの説明（`selectTheme` の意味、`検索前` の自動保存、タブ設定エディタでの選択方法等）が記載されている。

---

**設定場所（どこに書くか）**

- `setting.json`（プラグイン同梱のデフォルト設定ファイル）
- QGIS プロジェクト変数 `GEO-search-plugin`（プロジェクト個別設定）

各検索タブの設定 JSON に `"selectTheme": "テーマ名"` を書くことで、そのタブの検索実行時に指定テーマが適用されます。

例：
{
  "Title": "市区町村",
  # Map Themes — マニュアル

  目次

  - [概要](#概要)
  - [対象読者](#対象読者)
  - [クイックスタート](#クイックスタート)
  - [追加表示（Additive mode）とは](#追加表示additive-modeとは)
    - [動作フロー（短い要約）](#動作フロー短い要約)
    - [動作フロー（詳細）](#動作フロー詳細)
    - [凡例（レジェンド）復元の挙動](#凡例レジェンド復元の挙動)
  - [実装・内部仕様（開発者向け）](#実装内部仕様開発者向け)
    - [スナップショット形式](#スナップショット形式)
    - [互換性対策（QGIS API の多形）](#互換性対策qgis-api-の多形)
    - [主要関数一覧（API 参照）](#主要関数一覧api-参照)
  - [制限事項と既知の問題](#制限事項と既知の問題)
  - [テスト手順と検証チェックリスト](#テスト手順と検証チェックリスト)
  - [変更履歴 / 連絡先](#変更履歴--連絡先)


  ## 概要

  このドキュメントは `GEO-search-plugin` が提供する「マップテーマ」機能（map themes）と、
  プラグイン独自の「追加表示（Additive mode）」動作について説明します。まずはユーザー向けに
  簡潔に使い方を示し、その後に開発者向けの実装詳細と注意点をまとめます。

````markdown
```markdown
# マップテーマ（Map Themes）機能の概要 — テーマ管理サブシステム

このドキュメントは `GEO Search System` におけるテーマ／表示管理サブシステム（Map Themes）の設計と実装についてまとめたものです。検索サブシステムと連携して検索時の表示適用や「追加表示モード」を提供する役割を担います。

**目的（サブシステムとして）**
- QGIS のマップテーマ（Map Theme）を一覧取得・即時適用できるAPIとUIを提供し、検索ワークフローと統合する。
- プロジェクトのテーマコレクションが変更されたり（追加/削除）、プロジェクトが保存/読み込みされたときにコンボボックスを自動更新する。
- コンボボックスでテーマを選択すると、その場で該当テーマを適用する。
- 検索実行時には各タブ設定の `selectTheme`（設定ファイル / プロジェクト変数）を参照して、そのテーマを適用する。指定がなければテーマ切替は行わない。
- プラグイン起動時に現在の表示状態を `検索前` という名前で自動保存し、`selectTheme` に `検索前` を指定すると起動時の表示状態に復帰できる。

---

**実装のポイント（高レベル）**

- ツールバーに `QComboBox`（テーマ選択用）を追加し、プロジェクト内のマップテーマ一覧を表示する。
- プロジェクトのテーマコレクションが変更されたり（追加/削除）、プロジェクトが保存/読み込みされたときにコンボボックスを自動更新する。
- コンボボックスでテーマを選択すると、その場で該当テーマを適用する。
- 検索実行時には各タブ設定の `selectTheme`（設定ファイル / プロジェクト変数）を参照して、そのテーマを適用する。指定がなければテーマ切替は行わない。
- プラグイン起動時に現在の表示状態を `検索前` という名前で自動保存し、`selectTheme` に `検索前` を指定すると起動時の表示状態に復帰できる。

---

**主な実装ファイルと関数**

- `geo_search/plugin.py`
  - `initGui()`
    - ツールバーに `theme_combobox` を作成し `update_theme_combobox()` を呼ぶ。
    - プロジェクトの読み込み・保存イベントやテーマコレクションの変更を監視して `update_theme_combobox()` を再実行する接続を行う。
  - `update_theme_combobox()`
    - `QgsProject.instance().mapThemeCollection().mapThemes()` からテーマ名リストを取得し、コンボをクリアして `テーマ選択`（プレースホルダ）とテーマ群を再追加する。
    - 現在は、ツールバーのもう一つの `group_combobox` によるグループ絞り込みをサポートしており、グループが未選択（プレースホルダ `すべて`）の場合は全てのテーマを表示します。グループ選択がある場合はそのグループのテーマのみを表示します。
    - テーマ適用処理が走っている最中に QGIS 側のシグナルで誤ってリストが書き換わるのを防ぐため、適用中は自動更新を抑止する仕組みが入っています（`_suppress_theme_update` フラグ）。
  - `apply_selected_theme(index)`
    - コンボの選択イベントで呼ばれ、選択されたテーマ名を `theme_collection.applyTheme(theme_name, root, model)` で適用する。
    - 以前はプラグイン内で`選択を内部に記録して更新時に復元する`仕組みがありましたが、ユーザ操作の明示性を優先するためその自動復元ロジックは削除されています。
    - また、`applyTheme` によって内部的にテーマコレクションが変化した場合に発生し得る `mapThemesChanged` 等のシグナルで UI が書き換わらないよう、適用中は `update_theme_combobox()` を抑止するフラグを立てて一時的に更新を防ぎます。
  - `run()`
    - 検索ダイアログ表示の直前に現在の表示状態を `検索前` という名前で `mapThemeCollection` に保存する処理がある（検索実行前スナップショット）。

  目次

  - [概要](#概要)
  - [対象読者](#対象読者)
  - [クイックスタート](#クイックスタート)
  - [追加表示（Additive mode）とは](#追加表示additive-modeとは)
    - [動作フロー（短い要約）](#動作フロー短い要約)
    - [動作フロー（詳細）](#動作フロー詳細)
    - [凡例（レジェンド）復元の挙動](#凡例レジェンド復元の挙動)
  - [実装・内部仕様（開発者向け）](#実装内部仕様開発者向け)
    - [スナップショット形式](#スナップショット形式)
    - [互換性対策（QGIS API の多形）](#互換性対策qgis-api-の多形)
    - [主要関数一覧（API 参照）](#主要関数一覧api-参照)
  - [制限事項と既知の問題](#制限事項と既知の問題)
  - [テスト手順と検証チェックリスト](#テスト手順と検証チェックリスト)
  - [変更履歴 / 連絡先](#変更履歴--連絡先)


  ## 概要

  このドキュメントは `GEO-search-plugin` が提供する「マップテーマ」機能（map themes）と、
  プラグイン独自の「追加表示（Additive mode）」動作について説明します。まずはユーザー向けに
  簡潔に使い方を示し、その後に開発者向けの実装詳細と注意点をまとめます。


  ## 対象読者

  - エンドユーザー（QGIS 上でプラグインを使いテーマを切替える人）
  - 開発者（プラグインの挙動を理解・拡張・デバッグしたい人）

  ## サブシステム図と境界（開発者向け）

  簡易図（テキスト）:

  ```
    [Search Subsystem]  --(requests theme apply)->  [Theme Management Subsystem]
             ^                                              |
             |                                              v
      UI (Search dialog)                            Theme storage / snapshot
                                                    (collect_visible_layer_snapshot)
                                                    (collect_visible_layer_reload)
  ```

  主要境界関数／実装参照:

  - `geo_search/plugin.py`
    - `update_theme_combobox()` — UI 側のテーマリスト更新
    - `apply_selected_theme()` — UI から直接テーマ適用
  - `geo_search/searchfeature.py`
    - `SearchFeature` の `show_features()` — 検索からテーマ適用要求を行う接点
  - `geo_search/theme.py` (実装上の主要関数)
    - `collect_visible_layer_snapshot(root, snapshot_name=...)` — 可視レイヤのスナップショット取得
    - `collect_visible_layer_reload(snapshot_name, ...)` — スナップショットを現在の表示に反映（追加表示ロジック）
    - `apply_legend_visibility(layer, legend_state, overwrite_all=False)` — 凡例状態を適用する
    - `_get_layer_style_name(layer)` / `_apply_layer_style_by_name(layer, style_name, ...)` — スタイル名の取得とベストエフォート適用

  連携ポイント（Search ↔ Theme）:

  - 検索タブ設定の `selectTheme` を通じて、Search サブシステムが Theme サブシステムに「指定テーマを適用してほしい」と依頼する。
  - `additive`（追加表示モード）フラグがある場合、Theme サブシステムは tmp テーマの保存→適用→スナップショット取得→元復元→スナップショット反映 のフローで UI を破壊せずに表示を変更する。

  このセクションは、開発者がどこを参照すれば Search ↔ Theme の連携実装が分かるかを素早く掴めるようにするための要約です。


  ## クイックスタート

  1. QGIS でプロジェクトを開く。
  2. プラグインのテーマ機能を呼び出す。
  3. 通常のテーマ置換は `additive=False`（デフォルト）。
  4. 既存の表示は維持しつつ「選択したテーマのレイヤを追加表示」したい場合は `additive=True` を指定して適用する。

  注意: 追加表示モードは「選択テーマのレイヤを追加するが、元のビューは可能な限り復元する」ことを目指します。


  ## 追加表示 (Additive mode) とは

  追加表示モードは、テーマを単に置き換えるのではなく、選択したテーマに含まれるレイヤだけを現在のビューに
  "追加" して、かつ元の表示（グループや他のレイヤの可視状態）を復元するための補助機能です。これにより
  元のカスタム表示を壊さずに別テーマの要素を取り込めます。


  ### 動作フロー（短い要約）

  1. 現在の状態を一時テーマ（tmp_prev）として保存する。
  2. 選択テーマを適用する。
  3. 選択テーマ適用後の"選択テーマ側の可視レイヤのスナップショット"を保存（tmp_sel）。
  4. tmp_prev を復元（UIは元に戻る）。
  5. tmp_sel スナップショットを読み込み、対応するレイヤを現在のツリーで可視化（親グループも可視にする）、
     必要に応じて凡例の可視項目を調整する。
  6. tmp テーマは削除する。

  ### 動作フロー（詳細）

  - 保存されるスナップショットには以下が含まれます:
    - レイヤの順序（テーマ内での並び）
    - レイヤ ID（存在する場合）
    - レイヤ名（表示名）
    - 凡例（レジェンド）項目の配列とそれぞれの `visible` フラグ
    - レイヤのスタイル名／ID（`style`）：復元時にスタイルを再適用するために保存します

  - スナップショットの保存場所: モジュール変数に保持（プロセス内メモリ）。

  - 再適用時の処理:
    - スナップショットの各エントリについて、プロジェクト内で ID を優先してレイヤを検索し、
      ID が見つからない場合は名前でフォールバック検索を行う。
    - 見つかったレイヤの LayerTree ノードを取得し、ノードを可視化する。ノードがネストされている場合は
      親グループを上位に向かって可視化する。
    - レイヤの凡例状態は `apply_legend_visibility` を通じて適用される（詳しくは次節）。

  ### 凡例（レジェンド）復元の挙動
    #### 【カテゴリ凡例のカテゴリマージ対応】
    - 本プラグインの凡例復元処理（カテゴリレンダラー対応）では、カテゴリ値が複数値（リスト/タプル/カンマ区切り文字列等）で保存されている場合でも、
      それぞれの値を分解し、既存カテゴリとマージ（部分一致・複数キー対応）する実装となっています。
    - 例えば、テーマ保存時に「A,B」という値で可視化されていたカテゴリが、復元時に「A」「B」個別のカテゴリとして存在する場合でも、
      どちらかが一致すれば可視化が有効化されます。
    - これにより、テーマ作成時と復元時でカテゴリ構成が異なっていても、できる限り意図した可視状態を再現します。
    - 詳細は `geo_search/theme.py` の `_apply_categorized_visibility` 実装を参照してください。

  デフォルト（安全モード）:

  - スナップショットで `visible==True` の凡例項目のみを有効化します。
  - 既に存在する項目の `visible==False` を勝手に有効化／無効化しないことで破壊的な変更を避けます。

  上書きモード (`overwrite_all=True`):

  - スナップショットに従って凡例項目の `visible` を True/False の両方で上書きします。
  - 主に「テーマ側の完全な凡例状態を再現したい」特殊ケースで使います。
  - レイヤが元々非可視で復元時に凡例を上書きするケースでは、凡例のオン/オフを上書きする前にスナップショットに保存された `style`（スタイル名/ID）を先に適用します。スタイル適用に成功すれば、スタイル依存の凡例表現（ルールの有効化など）がより正確に再現されます。

  実装上はレンダラーの種類（カテゴリ分け、ルールベース、グラデュエーテッドなど）で API が異なるため、
  ラベル一致やカテゴリ値の分解・マージなどベストエフォートな照合を行います。カテゴリ凡例では値の分割・複数キー対応によりマージ挙動となります。
  ラベルが重複する場合や、カテゴリ値の構造が異なる場合は意図しないマッチングが発生することがあります。

  ## 実装・内部仕様（開発者向け）

  このセクションはプラグイン内部のメカニズムを理解するための資料です。

  ### スナップショット形式

  スナップショットは Python の辞書配列（JSON にシリアライズ可能な形）で保存されます。各エントリの代表例:

  ```json
  {
    "order": 3,
    "id": "c2f3...",
    "name": "道路レイヤ",
    "legend": {
      "items": [
        {"label": "主要道路", "visible": true},
        {"label": "歩道", "visible": false}
      ]
    ,
    "style": "<style-name-or-id>"
    }
  }
  ```

  保存先: モジュール変数 `_visible_layer_snapshots`（キー: スナップショット名、値: 上記の配列）

  ### 互換性対策（QGIS API の多形）

  QGIS のバージョン差異に備えて、多くの箇所で複数の属性名・メソッド名を試す実装になっています。
  例: ノードの可視化では `setItemVisibilityChecked`, `setVisible`, `setIsVisible` の順で存在する API を探索します。

  ### 主要関数一覧（API 参照）
    - `_apply_categorized_visibility(layer, items, overwrite_all=False, log_func=None)`
      - カテゴリ凡例の復元時、カテゴリ値を分解し複数キーで既存カテゴリとマージするロジックを含みます。
      - 例：保存時「A,B」→復元時「A」「B」両方に可視化が反映される。

  - `collect_visible_layer_snapshot(root, snapshot_name=None, ...)` — 現在の可視レイヤー情報を収集し、
    `snapshot_name` が与えられれば `_visible_layer_snapshots` に保存する。ログは `QgsMessageLog` を使う。
  - `_get_layer_style_name(layer)` — レイヤからスタイル名/ID を取得するユーティリティ。
  - `_apply_layer_style_by_name(layer, style_name, log_func=None)` — 保存済みのスタイル名をベストエフォートで適用するユーティリティ。
  - `get_visible_layer_snapshot(name)` — 保存済みスナップショットを返す（なければ None）。
  - `list_visible_layer_snapshots()` — 利用可能なスナップショット名一覧を返す。
  - `collect_visible_layer_reload(snapshot_name, project=None, root=None, ...)` — スナップショットを現在の
    プロジェクト上へ反映する。レイヤの検索、親グループ可視化、凡例項目の適用を行う。
  - `apply_legend_visibility(layer, legend_state, overwrite_all=False)` — 指定レイヤのレンダラーに応じて
    凡例項目の可視フラグを適用する。`overwrite_all` により完全上書きか部分有効化のみかを選べる。
  - `apply_theme(theme_name, additive=False, ...)` — 既存の `apply_theme` において、`additive=True` の場合は
    上記フローで tmp テーマを使った保存／スナップショット／復元を行う。

  ## 制限事項と既知の問題

  - QGIS ランタイムで実行して検証することが必須です。開発環境（QGIS がない環境）では `qgis.core` 等の
    インポートは解決されません。
  - 凡例ラベルの一致はラベル文字列に依存するため、同一ラベルが複数存在する場合は意図しないマッチングが発生することがあります。
  - カテゴリ凡例の復元では、カテゴリ値の分割・複数キー対応によるマージ挙動があるため、保存時と復元時でカテゴリ構成が異なる場合でも一部カテゴリが可視化される場合があります。
  - スナップショットはデフォルトでプロセス内にのみ保存され、プロジェクトに永続化されません。プラグイン再起動で消えます。

  ## テスト手順と検証チェックリスト

  1. 任意の QGIS プロジェクトを用意する（複数のグループ、カテゴリ表現の凡例を含むとよい）。
  2. 現在の表示のスクリーンショットを保存する。
  3. テーマを `additive=True` で適用する。
  4. 次を確認する:
     - `tmp_prev` と `tmp_sel` という一時テーマが保存され、ログに名前が出ていること（QgsMessageLog を確認）。
     - 復元後、元のレイヤやグループが可視のままであること。
     - 追加されたテーマ側のレイヤが期待通りに表示され、凡例の項目が正しく有効化されていること。
  5. 上書きモードで凡例を復元するテスト:
     - `apply_legend_visibility(..., overwrite_all=True)` を直接呼び出せる環境で、完全に一致するか確認する。

  **今後の改善案**

  - テーマ名を選択する UI をタブ設定ダイアログの中で動的に更新し、存在しないテーマを選べないようにする（現在は文字列フィールドとして扱える）。
  - テーマ適用時にオプション（例: レイヤの ON/OFF のみ適用、ラベルのみ適用、など）を追加する。
  - テーマ保存時に、`検索前` の多重保存を避けるためタイムスタンプ付きの一時テーマ名を使うか、既存の `検索前` を上書きする現在の動作を明確化する。

  ---

  作成: GEO-search-plugin のコードベース調査に基づくドキュメント

  （補足: 実装の細かいログ出力や互換処理は `geo_search/plugin.py` および `geo_search/searchfeature.py` を参照してください）

  ## 追加表示（Additive mode）について（詳細）

  ### 概要
  - 追加表示（additive）モードは、選択したテーマで表示されるレイヤを「現在の表示に追加」する挙動です。つまり選択テーマによって表示が上書きされるのではなく、テーマに含まれる可視レイヤを現在の表示に付け加えます。
  - 主に検索時に用いられる動作で、検索対象のレイヤだけを一時的に追加表示したい場合に便利です。

  ### 内部フロー（実装のポイント）
  1. 現在の表示状態を一時テーマとして保存します（`tmp_prev`）。
  2. 選択したテーマを適用します（QGIS の `applyTheme` を呼ぶ）。
  3. 選択テーマ適用後の「可視レイヤ一覧」と各レイヤの凡例状態（legend）をメモリにスナップショットとして保存します（`tmp_sel` 相当）。実装上は `collect_visible_layer_snapshot(..., snapshot_name=...)` を使います。
  4. 元の表示（`tmp_prev`）を復元して画面を元に戻します。
  5. 保存したスナップショットを `collect_visible_layer_reload(snapshot_name, ...)` で現在の表示に反映します（追加可視化）。このとき、見つかったレイヤのレイヤツリー上の親グループを上へたどり、親グループ自体を可視にしてから当該レイヤを可視にします。
  6. 最後に一時テーマ（`tmp_prev` / `tmp_sel`）はテーマコレクションから削除します。

  ### 凡例（legend）再現の方針
  - 保存されるスナップショットには各レイヤの凡例状態（`get_layer_legend_state` の出力）が含まれます。これにより復元時に凡例の状態を反映できますが、実装の互換性を保つため以下の方針を採っています。
  - レイヤが「元の状態で可視」だった場合：スナップショットで `visible==True` とマークされた凡例項目のみを有効化します（既存で非可視の項目はそのままにします）。
  - レイヤが「元の状態で非可視」だった場合：スナップショットの凡例項目の可視/非可視を上書きします（`overwrite_all=True` 相当）。つまり `visible==True` は有効化、`visible==False` は無効化を試みます。これにより、非表示だったレイヤを復元したときに凡例内の表示/非表示もスナップショットどおりに再現できます。

  ### 互換性と制限事項
  - QGIS の内部 API（`QgsLayerTreeNode` / `QgsLayerTreeGroup` / `QgsRuleBasedRenderer` 等）はバージョンによってメソッド名や振る舞いが異なるため、プラグインは多数の可能性のある API 名（例: `setItemVisibilityChecked`, `setVisible`, `setIsVisible`, `setActive` など）を順に試すベストエフォート実装です。環境によっては完全に再現できない場合があります。
  - 凡例項目の「有効化／無効化」はレンダラーの種類（カテゴリ・段階・ルールベース）ごとに異なるオブジェクトを操作するため、ラベル一致での探索を行っています。ラベルが重複している場合やラベルが動的に生成される環境では期待通りにマッチしないことがあります。
  - スナップショットはメモリ上に保存されます（`_visible_layer_snapshots`）。プロセスを跨いだ永続化は行っていません。必要な場合は将来ファイル化／プロジェクト属性への保存を検討してください。

  ### テスト手順（推奨）
  1. QGIS 上で通常のレイヤ構成を作る（いくつかのグループ・ルールベースレンダラーを含めると良い）。
  2. 追加表示させたいテーマを作成し保存する（テーマはレイヤの ON/OFF と凡例の一部設定を含めます）。
  3. プラグインの該当 UI からテーマを選択し、additive=True の経路を通して適用する（プラグインのツールや API 呼び出し経由）。
  4. 選択テーマ適用→復元→スナップショット反映が行われ、選択テーマで可視にしたかったレイヤが現在のビューに追加表示されることを確認する。
  5. 非可視レイヤの凡例がスナップショット時と同一（可／非）になるケースと、可視レイヤの凡例項目のみが追加されるケースの両方を確認する。

  ### 実装上の主要関数（参照）
  - `collect_visible_layer_snapshot(root, log_layer_legend_state, snapshot_name=...)` — 可視レイヤ一覧と凡例状態をメモリにスナップショット保存します。既存のログ出力も行います。
  - `collect_visible_layer_reload(snapshot_name, project=None, root=None, ...)` — スナップショットを読み出し、見つかったレイヤを現在の表示に追加可視化します。親グループも遡って可視化します。
  - `apply_legend_visibility(layer, legend_state, overwrite_all=False)` — スナップショットの凡例状態をレイヤ上に反映します。`overwrite_all=True` にすると可視/非可視の両方を上書きします（非可視レイヤ再現時に使用）。

  ### 追加改善案（任意）
  - スナップショットをプロジェクト属性や一時ファイルに永続化して、QGIS を跨いだ復元をサポートする。
  - スナップショットにタイムスタンプや取得元テーマ名を付与し、ユーザに一覧選択させる UI を作る。
  - グループの展開状態（expanded）も復元する（`setExpanded(True)` 等）。現在は可視フラグのみを優先しています。

  ```
