```markdown
# マップテーマ（Map Themes）機能の概要

このドキュメントはプラグイン内の「マップテーマ選択／適用機能」について、何をしているか・どのファイルで実装しているか・設定方法と拡張方法を整理したものです。

**目的**
- QGIS のマップテーマ（Map Theme）をプラグイン側から一覧取得・即時適用できるようにする。
- 検索実行時にあらかじめ設定されたテーマを自動で適用し、検索後に元の表示へ戻せるようにする（自動保存された「検索前」テーマを利用）。

---

**実装のポイント（高レベル）**

- ツールバーに `QComboBox`（テーマ選択用）を追加し、プロジェクト内のマップテーマ一覧を表示する。
- プロジェクトのテーマコレクションが変更されたり（追加/削除）、プロジェクトが保存/読み込みされたときにコンボボックスを自動更新する。
- コンボボックスでテーマを選択すると、その場で該当テーマを適用する。
- 検索実行時には各タブ設定の `selectTheme`（設定ファイル / プロジェクト変数）を参照して、そのテーマを適用する。指定がなければテーマ切替は行わない。
- プラグイン起動時に現在の表示状態を "検索前" という名前で自動保存し、`selectTheme` に "検索前" を指定すると起動時の表示状態に復帰できる。

---

**主な実装ファイルと関数**

- `geo_search/plugin.py`
  - `initGui()`
    - ツールバーに `theme_combobox` を作成し `update_theme_combobox()` を呼ぶ。
    - プロジェクトの読み込み・保存イベントやテーマコレクションの変更を監視して `update_theme_combobox()` を再実行する接続を行う。
  - `update_theme_combobox()`
    - `QgsProject.instance().mapThemeCollection().mapThemes()` からテーマ名リストを取得し、コンボをクリアして "テーマ選択"（プレースホルダ）とテーマ群を再追加する。
    - 前回選択していた項目が存在すれば再選択するロジックがある。
  - `apply_selected_theme(index)`
    - コンボの選択イベントで呼ばれ、選択されたテーマ名を `theme_collection.applyTheme(theme_name, root, model)` で適用する。
  - `run()`
    - 検索ダイアログ表示の直前に現在の表示状態を `検索前` という名前で `mapThemeCollection` に保存する処理がある（検索実行前スナップショット）。

- `geo_search/searchfeature.py`
  - `SearchFeature.show_features()`（および、派生クラスの呼び出し箇所）
    - `self.setting.get('selectTheme')` を読み、存在かつプロジェクトに存在するテーマ名であればそのテーマを適用する。
    - `selectTheme` が未指定なら何もしない。設定があるが見つからない場合はログに警告を書く。
    - `selectTheme` が未指定でも `検索前` が存在する場合は `検索前` を適用する（下位互換的な扱い）。

- `README.md`
  - ユーザ向けの説明（`selectTheme` の意味、`検索前` の自動保存、タブ設定エディタでの選択方法等）が記載されている。

---

**設定場所（どこに書くか）**

- `setting.json`（プラグイン同梱のデフォルト設定ファイル）
- QGIS プロジェクト変数 `GEO-search-plugin`（プロジェクト個別設定）

各検索タブの設定 JSON に `"selectTheme": "テーマ名"` を書くことで、そのタブの検索実行時に指定テーマが適用されます。

例：
{
  "Title": "市区町村",
  "selectTheme": "行政区域テーマ"
}
**グループ化と括弧のカスタマイズ**

- テーマ名に含まれるグループは、テーマ名中の括弧で囲まれた部分を解析して抽出され、プラグインの UI（テーマ選択コンボ）でグループごとに整理して表示されます。
- 使用する括弧は環境変数 `THEME_BRACKET_OPEN`（開き括弧）と `THEME_BRACKET_CLOSE`（閉じ括弧）で変更できます。両方未指定の場合はデフォルトで `【` と `】` が使われます。
- 例: `道路【道路種別】_昼` → グループ名 `道路種別`
- 環境変数は QGIS 起動前に設定してください。プラグインは起動時にこれらの値を読み込みます（動的な変更はプラグイン再起動が必要になる場合があります）。

`selectTheme` に `"検索前"` を指定すると、プラグイン起動時に自動保存された表示状態が適用されます。

---

**動作フロー（簡易）**

- プラグイン初期化（`initGui`）
  - `theme_combobox` を作成、`update_theme_combobox()` 実行
  - `QgsProject` のイベントにハンドラを接続（projectRead, projectSaved, mapThemesChanged 等）
- ユーザがツールバーのドロップダウンでテーマを選択
  - `apply_selected_theme()` が呼ばれ、即時 `applyTheme` でテーマ適用
- 検索実行（ユーザが検索ボタンを押す）
  - `run()` で現在表示状態を `検索前` として保存（上書き）
  - 検索処理（`SearchFeature.show_features()`）で `selectTheme` を確認し、適用するテーマがあれば `applyTheme` を呼ぶ

---

**ユーザー向け：テーマを使う手順**

1. QGIS のレイヤツリーで目的の表示（レイヤの ON/OFF）を作る。
2. QGIS のメニュー `レイヤ` → `レイヤ表示プレセット` などからテーマを保存（バージョンにより UI 名は異なる）。
3. プラグインのタブ設定編集で `selectTheme` に保存したテーマ名を選択する（または手動で `setting.json` / プロジェクト変数に設定）。
4. 検索を実行すると指定テーマが適用される。
5. `selectTheme` を空にするとテーマ切替は行われない。

---

**拡張・変更時の注意点（開発者向け）**

- `mapThemeCollection` のシグナル名は QGIS のバージョンによって異なる場合があるため、`plugin.py` では複数の候補（`mapThemesChanged` / `changed`）に対して接続を試みている。
- `applyTheme` の呼び出しはレイヤツリーの `root` と `layerTreeModel` を引数に取る。適用後に UI の更新（`QApplication.processEvents()`）が必要な場合がある。
- コンボボックスはプラグインの unload 時に確実に破棄する（`deleteLater()`）こと。すでに実装済み。
- テーマ名は文字列一致で判定しているため、同名の微妙な差異（全角・半角や空白）は注意。

---

**トラブルシュート**

- テーマ名がリストに出てこない
  - QGIS プロジェクトにテーマが保存されているか確認する。
  - `update_theme_combobox()` は `projectRead` / `projectSaved` / テーマ変更イベントにより自動更新される。手動で保存後に `projectSaved` すると反映される。

- `selectTheme` を指定しているのに適用されない
  - `selectTheme` の名前が正確か確認（大文字小文字、スペース等）。
  - プロジェクトに該当のテーマが存在するか確認。
  - プラグインのログ（QGIS のメッセージログ）に `テーマ '...' が見つかりません` のようなメッセージが出ていないか確認する。

---

**今後の改善案**

- テーマ名を選択する UI をタブ設定ダイアログの中で動的に更新し、存在しないテーマを選べないようにする（現在は文字列フィールドとして扱える）。
- テーマ適用時にオプション（例: レイヤの ON/OFF のみ適用、ラベルのみ適用、など）を追加する。
- テーマ保存時に、`検索前` の多重保存を避けるためタイムスタンプ付きの一時テーマ名を使うか、既存の `検索前` を上書きする現在の動作を明確化する。

---

作成: GEO-search-plugin のコードベース調査に基づくドキュメント

（補足: 実装の細かいログ出力や互換処理は `geo_search/plugin.py` および `geo_search/searchfeature.py` を参照してください）

``` 
